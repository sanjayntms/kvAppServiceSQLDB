name: Build Full Azure Environment + Deploy App

on:
  workflow_dispatch:

jobs:
  deploy-infra-and-app:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Define Variables
      id: vars
      run: |
        echo "RG=sqlkv-demo-rg" >> $GITHUB_ENV
        echo "LOC=centralindia" >> $GITHUB_ENV
        echo "SQL_SERVER=kvsqlserver$RANDOM" >> $GITHUB_ENV
        echo "DB_NAME=demoDB" >> $GITHUB_ENV
        echo "KV_NAME=kv-demo-$RANDOM" >> $GITHUB_ENV
        echo "APP_NAME=kvsqlapp$RANDOM" >> $GITHUB_ENV
        echo "PLAN_NAME=kvsqlplan" >> $GITHUB_ENV

    - name: Create Resource Group
      run: az group create -n $RG -l $LOC

    - name: Create SQL Server + DB
      run: |
        PASSWORD="P@ssw0rd123#"
        az sql server create -n $SQL_SERVER -g $RG -l $LOC -u sqladmin -p "$PASSWORD"
        az sql db create -n $DB_NAME -s $SQL_SERVER -g $RG --service-objective Basic
        echo "CONNSTR=Server=tcp:$SQL_SERVER.database.windows.net,1433;Database=$DB_NAME;User ID=sqladmin;Password=$PASSWORD;Encrypt=true;" >> $GITHUB_ENV

    - name: Create Key Vault + Store Secret
      run: |
        az keyvault create -n $KV_NAME -g $RG -l $LOC
        az keyvault secret set --vault-name $KV_NAME --name SqlConnString --value "$CONNSTR"

    - name: Create App Service Plan + Web App
      run: |
        az appservice plan create -g $RG -n $PLAN_NAME --sku B1 --is-linux
        az webapp create -g $RG -p $PLAN_NAME -n $APP_NAME --runtime "PYTHON:3.10"

    - name: Enable Managed Identity
      run: |
        APP_ID=$(az webapp identity assign -g $RG -n $APP_NAME --query principalId -o tsv)
        az keyvault set-policy -n $KV_NAME --object-id $APP_ID --secret-permissions get

    - name: Set Key Vault Reference in App Settings
      run: |
        SECRET_URI=$(az keyvault secret show --vault-name $KV_NAME --name SqlConnString --query id -o tsv)
        az webapp config appsettings set -g $RG -n $APP_NAME --settings \
          SQL_CONN="@Microsoft.KeyVault(SecretUri=$SECRET_URI)"

    - name: Zip Application
      run: |
        cd app
        zip -r ../app.zip .

    - name: Deploy to App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        resource-group: ${{ env.RG }}
        package: app.zip
