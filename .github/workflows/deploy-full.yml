name: Deploy Full Azure Environment + Python App

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Source Code
      uses: actions/checkout@v4

    # -----------------------
    # Authenticate to Azure
    # -----------------------
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -----------------------
    # Set Global Variables
    # -----------------------
    - name: Set Variables
      run: |
        echo "SUBSCRIPTION=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
        echo "RG=kvsql-demo-rg" >> $GITHUB_ENV
        echo "LOC=centralindia" >> $GITHUB_ENV
        echo "SQL_SERVER=kvsqlserverdemo" >> $GITHUB_ENV
        echo "DB_NAME=demoDB" >> $GITHUB_ENV
        echo "KV_NAME=kvsqlvaultdemo" >> $GITHUB_ENV
        echo "PLAN_NAME=kvsqlplan" >> $GITHUB_ENV
        echo "APP_NAME=kvsqlappdemo" >> $GITHUB_ENV

    # -----------------------
    # Resource Group
    # -----------------------
    - name: Create Resource Group
      run: |
        az group create -n $RG -l $LOC

    # -----------------------
    # SQL Server + DB
    # -----------------------
    - name: Create SQL Server + Database
      run: |
        PASSWORD="P@ssw0rd123#"

        az sql server show -n $SQL_SERVER -g $RG || \
          az sql server create -n $SQL_SERVER -g $RG -l $LOC -u sqladmin -p "$PASSWORD"

        az sql db show -n $DB_NAME -s $SQL_SERVER -g $RG || \
          az sql db create -n $DB_NAME -s $SQL_SERVER -g $RG --service-objective Basic
    
        echo "CONNSTR=Server=tcp:$SQL_SERVER.database.windows.net,1433;Database=$DB_NAME;Uid=sqladmin;Pwd=$PASSWORD;Encrypt=yes;" >> $GITHUB_ENV
    # Server=tcp:kvsqlserverdemo.database.windows.net,1433; Database=demoDB; Uid=sqladmin; Pwd=P@ssw0rd123#; Encrypt=yes; Driver={ODBC Driver 17 for SQL Server}
    # -----------------------
    # Key Vault (RBAC Mode)
    # -----------------------
    - name: Create Key Vault (RBAC)
      run: |
        az keyvault show -n $KV_NAME -g $RG || \
          az keyvault create -n $KV_NAME -g $RG -l $LOC --enable-rbac-authorization true

    # -----------------------
    # Give GitHub SP permission to write the secret
    # -----------------------
    - name: Assign RBAC - GitHub SP (Secrets Officer)
      run: |
        SP_OBJID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)

        az role assignment create \
          --role "Key Vault Secrets Officer" \
          --assignee-object-id $SP_OBJID \
          --scope /subscriptions/$SUBSCRIPTION/resourceGroups/$RG/providers/Microsoft.KeyVault/vaults/$KV_NAME \
          || echo "Role assignment already exists."

    # -----------------------
    # Store SQL Connection String in KV
    # -----------------------
    - name: Store SQL Connection Secret
      run: |
        az keyvault secret set \
          --vault-name $KV_NAME \
          --name sql-conn-string \
          --value "$CONNSTR"

    # -----------------------
    # App Service Plan
    # -----------------------
    - name: Create App Service Plan
      run: |
        az appservice plan show -g $RG -n $PLAN_NAME || \
          az appservice plan create -g $RG -n $PLAN_NAME --sku B1 --is-linux

    # -----------------------
    # Web App
    # -----------------------
    - name: Create App Service
      run: |
        az webapp show -g $RG -n $APP_NAME || \
          az webapp create -g $RG -n $APP_NAME -p $PLAN_NAME --runtime "PYTHON:3.10"

    # -----------------------
    # Enable Python Build Automation
    # -----------------------
    - name: Enable Build Automation
      run: |
        az webapp config appsettings set \
          -g $RG \
          -n $APP_NAME \
          --settings SCM_DO_BUILD_DURING_DEPLOYMENT=true

    # -----------------------
    # Assign RBAC Role to App MI
    # -----------------------
    - name: Assign RBAC - App Service Identity (Secrets User)
      run: |
        APP_ID=$(az webapp identity assign -g $RG -n $APP_NAME --query principalId -o tsv)

        az role assignment create \
          --role "Key Vault Secrets User" \
          --assignee-object-id $APP_ID \
          --scope /subscriptions/$SUBSCRIPTION/resourceGroups/$RG/providers/Microsoft.KeyVault/vaults/$KV_NAME \
          || echo "Role assignment already exists."

    # -----------------------
    # Inject KEY_VAULT_URI into App Settings
    # -----------------------
    - name: Set KEY_VAULT_URI App Setting
      run: |
        KV_URI=$(az keyvault show -n $KV_NAME -g $RG --query properties.vaultUri -o tsv)

        az webapp config appsettings set \
          -g $RG \
          -n $APP_NAME \
          --settings KEY_VAULT_URI=$KV_URI

    # -----------------------
    # Zip Python App
    # -----------------------
    - name: Package Python App
      run: |
        mkdir -p output
        cd app
        zip -r ../output/app.zip .

    # -----------------------
    # Deploy Application
    # -----------------------
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        resource-group: ${{ env.RG }}
        package: output/app.zip
